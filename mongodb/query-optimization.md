# Query Optimization

## Explain
Mongodb 도 쿼리 플랜을 알기 위해 `explain` 이라는 값을 사용한다.

주요 필드는 다음과 같다.

### isMultiKey
다중키 인덱스 사용 여부

### nReturned
쿼리에 의해 반환된 도큐먼트 개수

### totalDocsExamined
몽고디비가 디스크 내 실제 도큐먼트를 가리키는 인덱스 포인터를 따라간 횟수.

### totalKeysExamine
인덱스가 사용되었다면 살펴본 인덱스 항목 개수, 테이블 스캔을 했다면 조사한 도큐먼트 개수.

### stage
몽고디비가 인덱스를 사용해 쿼리할 수 있었는지 여부 (`COLSCAN` 이면 컬렉션 스캔임)

### needYields
쓰기 요청을 처리하도록 쿼리가 양보(일시중지)한 횟수

### executionTimeMillis
데이터베이스가 쿼리하는 데 걸린 시간

### indexBounds
인덱스가 어떻게 사용되었는지 설명하며 탐색한 인덱스의 범위를 제공한다.

## Convered query
쿼리에서 사용되는 모든 필드가 인덱스에 포함이 되면, 도큐먼트를 찾을 때 스토리지에 갔다오지 않고 메모리에 있는걸 돌려주게 된다.

이를 커버드 쿼리라고 한다.

쿼리가 확실히 인덱스만 사용하게 하려면 `_id` 를 반환받지 않도록 해야 한다.

커버드 쿼리를 사용하게 되면 explain 할 때 아래와 같이 값이 나올 것이다.

```
"stage": "IXSCAN",
...
"totalDocsExamined": 0
```

## $ne, $nin
부정조건은 비효율적이다.

`$ne`와 같은 부정조건은 지정된 항목을 제외한 모든 인덱스 항목을 살펴봐야 하므로 기본적으로 전체 인덱스를 살펴봐야하기 때문이다.

`$nin` 은 항상 테이블 스캔을 수행한다.

## Embedding document index
내장 도큐먼트의 인덱 생성은 일반적인 생성과 동일하다.

다만, 내장 도큐먼트 전체를 인덱싱하는 것과 내장 도큐먼트의 특정 필드를 인덱싱하는 것은 다르다. 도큐먼트 전체를 인덱싱하게 될 경우 이 내장 도큐먼트 전체를 쿼리할 때만 도움이 된다.

## Cardinality
Cardinality 가 높을수록 인덱싱에 도움이 된다. 

예를 들어 gender 와 name 이 있을 경우 일반적으로 gender 의 카디널리티가 낮다. name 은 카디널리티가 높다. 이 때 성별과 이름으로 쿼리시에 name 이 인덱스인 편이 더 효율적이게 된다.

복합 인덱스를 만들게 되면 카디널리티가 높은 쪽을 앞에 두도록 하자.
