# Zookeeper
주키퍼는 기본적으로 분산 시스템을 위한 코디네이터다.

주키퍼는 데이터를 디렉토리 구조로 관리하며 key-value 스토리지 처럼 key 로 접근 가능하다.

> 물론 value 를 사용하지 않아도 된다. 그럴 땐 임의로 "" 와 같이 빈 문자열을 넣어준다.

## 주키퍼 API

주키퍼에는 다음과 같은 API 가 있다.

data 를 담고 있는 /path 라는 이름의 znode 생성
```
create /path data
```

/path 라는 znode 를 제거
```
delete /path
```

> 자바에서 API 를 호출해 삭제를 원한다면, 해당 znode 에 대한 버젼 정보가 반드시 포함되어야 한다.

/path 라는 znode 가 존재하는지 확인 (Stat)
```
exists /path
```

/path 라는 znode 에 data를 저장
```
setData /path data
```

/path 라는 znode의 데이터를 가져옴
```
getData /path
```

/path 라는 znode의 모든 자식 목록을 반환
```
getChildren /path
```

### 주키퍼의 노드 종류

주키퍼에는 총 4가지 종류의 노드가 있다. (3.5 기준으로 TTL, container 가 생겼다.)

- Persistent
영구적인 노드로 `delete` 를 이용해 제거가 가능하다.
- Ephemeral
임시 노드로 주키퍼 클라이언트와 세션이 끊기기 전까지 살아있다가, 끊기면 사라지는 노드이다. 혹은 세션을 맺은 클라이언트가 삭제해야 제거되는 노드이다.
- TTL
만약 znode가 주어진 TTL 시간 동안 변화가 없고 어떠한 자식 노드도 생성되지 않는다면 삭제가 된다. 다만 기본적으로 TTL 은 비활성화 되어 있으므로 이를 활성화 시키는 사전 작업이 필요하다.
- Container
컨테이너 노드는 자식 노드가 없을떄 삭제가 된다. 바로 삭제는 되지 않고 TTL 과 마찬가지로 삭제 노드의 후보가 되는 것이다. 즉 자식 노드가 있다가, 모두 삭제가 된다면 일정 시간 이후에 Container 노드로 설정한 노드는 삭제가 된다.

각 노드에는 순차적 (sequential) 노드도 존재한다. 단순히 노드가 생성되면 뒤에 sequential number 가 붙는다고 생각하면 된다. 즉 tasks 라는 zNode가 있을 때 해당 옵션(-s)으로 생성하면 tasks-(숫자) 가 붙는 것이다.

### 주키퍼의 와쳐 (Watcher)
데이터를 주기적으로 가져오기 위해 주키퍼에게 폴링하는 것은 주키퍼의 설계와는 맞지 않다. 이럴 때 사용하는 것이 와쳐 (Watcher) 다. 주키퍼는 어떤 znode 의 변화가 생길 것을 감지 하기 위해 와쳐를 등록할 수 있다.

주키퍼에서 znode 의 와쳐를 걸 수 있는 함수는 `exists`, `getData`, `getChildren` 이 있다.

각각 걸 수 있는 콜백 종류는 API 를 확인해보면 된다. `exists` 의 경우 `StatCallback` 으로 와쳐를 설정하면 노드의 생성, 삭제 이벤트가 와쳐로 들어오게 된다.

와쳐는 1회성이므로 한번 알림이 가면 해당 노드에 대해 다시 등록/설정을 해주어야 된다. 만약 1000개의 클라이언트가 동일한 znode 에 `exist` 함수로 와쳐를 등록했다면 해당 노드가 존재하지 않았다가, 생성된다면 1000개의 클라이언트에게 알람이 가게 된다. 이런 설계는 옳지 않다. 이상적으로는 한 개의 클라이언트만 하나의 znode 에 와쳐를 등록해야 한다.
