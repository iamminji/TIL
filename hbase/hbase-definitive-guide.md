# HBase 완벽 가이드

 HBase 에서 데이터는 HFile 이라는 파일에 저장되는데, 이 파일은 데이터가 영구 저장되고, 정렬되며, 고정 불면의 키 값/쌍의 맵이다.

 저장 파일은 일반적으로 하둡 분산 파일 시스템 (HDFS) 에 저장되는데 확장성 있고, 데이터가 영구 저장되며, 여러 사본으로 복제되는 저장 계층을 제공해준다.

 > 반드시 HDFS 만 사용해야 하는 것은 아니다.

 데이터가 갱신되면 제일 먼저 WAL `write-ahead Log` 에 씌어지는데, HBase에서는 커밋 로그라고 한다. 데이터는 이후 메모리 상의 멤스토어에 저장된다.
 메모리 상의 데이터가 설정된 최대값을 넘어서면 디스크에 HFile 로 플러시된다.

 이렇게 저장된 파일은 고정 불변이다. 따라서 삭제를 한다고 바로 삭제 되는 것이 아니라, 해당 키에 삭제 마킹(tombstone marker)을 한다.

삭제 마킹이 된 키는 major compaction 이 진행될 때 데이터를 제거 한다.

##### Major compaction
메이저 컴팩션은 하나의 리전 안의 컬럼 패밀리 하나를 구성하는 모든 파일을 새로운 파일 하나로 다시 쓰는 작업을 진행한다. 이 때 모든 키/값 쌍을 탐색하기 때문에 삭제 마킹 (툼스톤 마커) 이 된 키가 제거 될 수 있는 것이다.

##### Minor compaction
마이너 컴팩션ㄷ은 작은 파일의 내용을 적은 개수의 더 큰 파일로 다시 쓰는 방식이다.

메이저 컴팩션, 마이너 컴팩션 둘 다 HFile 을 줄이기 위한 병합 과정이다.

### HBase 의 구성 요소
HBase 에는 클라이언트 라이브러리, 마스터 서버 하나, 리전 서버 다수 이렇게 3개의 구성 요소가 있다. 마스터는 리전 서버에 리전을 할당하는 역할을 하는데 이 때 `zookeeper` 를 사용한다.

또한마스터는 리전 서버간에 리전의 부하 분산을 처리하는 역할도 담당한다.
